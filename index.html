<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HVAC Workflow Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#22d3ee;
  --green:#16a34a;
  --blue:#2563eb;
  --purple:#9333ea;
  --orange:#f59e0b;
  --danger:#ef4444;
}

body.light{
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* NAV */
nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 30px;
  background:var(--card);
  box-shadow:0 8px 30px rgba(0,0,0,.4);
}

nav h1{
  margin:0;
  font-size:18px;
  color:var(--accent);
}

.nav-actions{
  display:flex;
  gap:20px;
}

.nav-btn{
  cursor:pointer;
  font-size:14px;
  padding:6px 10px;
  border-radius:8px;
  background:rgba(255,255,255,.05);
}

/* VIEW SECTIONS */
.view{
  display:none;
  padding:30px;
}

.view.active{
  display:block;
}

/* DASHBOARD */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:20px;
}

.kpi{
  background:var(--card);
  padding:16px;
  border-radius:14px;
}

.kpi h4{
  margin:0;
  font-size:12px;
  color:var(--muted);
}

.kpi p{
  margin:8px 0 0;
  font-size:22px;
  font-weight:700;
}

/* KANBAN */
.kanban{
  display:flex;
  gap:20px;
  overflow-x:auto;
}

.column{
  min-width:280px;
  background:var(--card);
  border-radius:14px;
  padding:12px;
}

.column h3{
  margin:0 0 10px;
  font-size:13px;
}

.card{
  background:rgba(255,255,255,.05);
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
}

.card small{
  display:block;
  font-size:10px;
  color:var(--muted);
}

/* GRID */
.tile-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,280px));
  gap:20px;
}

.tile{
  background:var(--card);
  border-radius:14px;
  padding:12px;
}

.details{
  margin-top:10px;
  font-size:11px;
}

input,select{
  width:100%;
  margin-top:4px;
  padding:4px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
  color:var(--text);
}
</style>
</head>

<body>

<nav>
  <h1>HVAC Workflow Pro</h1>

  <div class="nav-actions">
    <div class="nav-btn" onclick="showView('dashboard')">Dashboard</div>
    <div class="nav-btn" onclick="showView('kanban')">Kanban</div>
    <div class="nav-btn" onclick="showView('grid')">Grid</div>
    <div class="nav-btn" onclick="toggleTheme()">ðŸŒ“</div>
  </div>
</nav>

<!-- DASHBOARD -->
<div id="dashboard" class="view active">
  <div class="kpi-grid" id="kpiGrid"></div>
</div>

<!-- KANBAN -->
<div id="kanban" class="view">
  <div class="kanban">
    <div class="column">
      <h3>ðŸŸ¢ Received</h3>
      <div id="col-received"></div>
    </div>
    <div class="column">
      <h3>ðŸ”µ Selection</h3>
      <div id="col-selection"></div>
    </div>
    <div class="column">
      <h3>ðŸŸ£ Quotation</h3>
      <div id="col-quotation"></div>
    </div>
    <div class="column">
      <h3>ðŸŸ  Completed</h3>
      <div id="col-completed"></div>
    </div>
  </div>
</div>

<!-- GRID -->
<div id="grid" class="view">
  <div class="tile-grid" id="tileGrid"></div>
</div>

<script>
const $=id=>document.getElementById(id);
let projects=JSON.parse(localStorage.getItem('hvacProjects'))||[];

/* NORMALIZE */
projects=projects.map(p=>({
  id:p.id,
  project:p.project,
  customer:p.customer||'',
  received:p.received||'',
  selection:p.selection===true,
  quotation:p.quotation===true,
  completed:p.completed===true,
  sent:p.sent||''
}));

function save(){
  localStorage.setItem('hvacProjects',JSON.stringify(projects));
}

/* VIEW SWITCH */
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  $(id).classList.add('active');
}

/* THEME */
function toggleTheme(){
  document.body.classList.toggle('light');
}

/* ================= DASHBOARD ================= */
function renderDashboard(){

  const total=projects.length;
  const selection=projects.filter(p=>p.selection&&!p.quotation).length;
  const quotation=projects.filter(p=>p.quotation&&!p.completed).length;
  const completed=projects.filter(p=>p.completed).length;

  const conversion= total ? ((completed/total)*100).toFixed(1) : 0;

  $('kpiGrid').innerHTML=`
    <div class="kpi"><h4>Total Received</h4><p>${total}</p></div>
    <div class="kpi"><h4>Selection Only</h4><p>${selection}</p></div>
    <div class="kpi"><h4>Quotation</h4><p>${quotation}</p></div>
    <div class="kpi"><h4>Completed</h4><p>${completed}</p></div>
    <div class="kpi"><h4>Conversion %</h4><p>${conversion}%</p></div>
    <div class="kpi"><button onclick="exportCSV()">Export Excel</button></div>
  `;
}

/* ================= OVERDUE CHECK ================= */
function isOverdue(date){
  if(!date) return false;
  const diff=(new Date()-new Date(date))/(1000*60*60*24);
  return diff>3;
}

/* ================= KANBAN ================= */
function renderKanban(){

  ['received','selection','quotation','completed']
  .forEach(col=>{
    const container=$('col-'+col);
    container.innerHTML='';
    container.ondragover=e=>e.preventDefault();
    container.ondrop=e=>handleDrop(e,col);
  });

  projects.forEach(p=>{
    let column='received';
    if(p.selection&&!p.quotation) column='selection';
    if(p.quotation&&!p.completed) column='quotation';
    if(p.completed) column='completed';

    const card=document.createElement('div');
    card.className='card';
    card.draggable=true;
    card.ondragstart=e=>e.dataTransfer.setData('id',p.id);

    if(isOverdue(p.received)&&!p.selection)
      card.style.border='1px solid red';

    card.innerHTML=`
      <strong>${p.project}</strong>
      <small>${p.customer}</small>
      <small>${p.received}</small>
    `;

    $('col-'+column).appendChild(card);
  });
}

function handleDrop(e,targetCol){
  const id=Number(e.dataTransfer.getData('id'));
  const p=projects.find(x=>x.id===id);

  if(targetCol==='received'){
    p.selection=false;
    p.quotation=false;
    p.completed=false;
  }

  if(targetCol==='selection'){
    p.selection=true;
    p.quotation=false;
    p.completed=false;
  }

  if(targetCol==='quotation'){
    p.selection=true;
    p.quotation=true;
    p.completed=false;
  }

  if(targetCol==='completed'){
    p.selection=true;
    p.quotation=true;
    p.completed=true;
  }

  save();
  renderAll();
}

/* ================= GRID ================= */
function renderGrid(){
  $('tileGrid').innerHTML='';

  projects.forEach(p=>{
    const tile=document.createElement('div');
    tile.className='tile';

    tile.innerHTML=`
      <strong>${p.project}</strong>
      <small>${p.customer}</small>

      <div class="details">
        <label><input type="checkbox" ${p.selection?'checked':''}
        onchange="update(${p.id},'selection',this.checked)"> Selection</label>

        <label><input type="checkbox" ${p.quotation?'checked':''}
        onchange="update(${p.id},'quotation',this.checked)"> Quotation</label>

        <label><input type="checkbox" ${p.completed?'checked':''}
        onchange="update(${p.id},'completed',this.checked)"> Completed</label>
      </div>
    `;

    $('tileGrid').appendChild(tile);
  });
}

function update(id,key,value){
  const p=projects.find(x=>x.id===id);
  p[key]=value;

  if(key==='completed' && value===true){
    p.selection=true;
    p.quotation=true;
  }

  save();
  renderAll();
}

/* ================= EXPORT ================= */
function exportCSV(){
  let csv="Project,Customer,Received,Selection,Quotation,Completed\n";
  projects.forEach(p=>{
    csv+=`${p.project},${p.customer},${p.received},${p.selection},${p.quotation},${p.completed}\n`;
  });

  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download="hvac_workflow.csv";
  a.click();
}

/* ================= MASTER RENDER ================= */
function renderAll(){
  renderDashboard();
  renderKanban();
  renderGrid();
}

renderAll();
</script>

</body>
</html>
